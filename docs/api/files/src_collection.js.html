<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\collection.js - yamvc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="yamvc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ya.html">ya</a></li>
            
                <li><a href="../classes/ya.$promise.html">ya.$promise</a></li>
            
                <li><a href="../classes/ya.Collection.html">ya.Collection</a></li>
            
                <li><a href="../classes/ya.Controller.html">ya.Controller</a></li>
            
                <li><a href="../classes/ya.Core.html">ya.Core</a></li>
            
                <li><a href="../classes/ya.data.Action.html">ya.data.Action</a></li>
            
                <li><a href="../classes/ya.data.Proxy.html">ya.data.Proxy</a></li>
            
                <li><a href="../classes/ya.data.proxy.Localstorage.html">ya.data.proxy.Localstorage</a></li>
            
                <li><a href="../classes/ya.event.$dispatcher.html">ya.event.$dispatcher</a></li>
            
                <li><a href="../classes/ya.mixins.Array.html">ya.mixins.Array</a></li>
            
                <li><a href="../classes/ya.mixins.CoreStatic.html">ya.mixins.CoreStatic</a></li>
            
                <li><a href="../classes/ya.mixins.GetSet.html">ya.mixins.GetSet</a></li>
            
                <li><a href="../classes/ya.mixins.Observable.html">ya.mixins.Observable</a></li>
            
                <li><a href="../classes/ya.mixins.Selector.html">ya.mixins.Selector</a></li>
            
                <li><a href="../classes/ya.Model.html">ya.Model</a></li>
            
                <li><a href="../classes/ya.Router.html">ya.Router</a></li>
            
                <li><a href="../classes/ya.View.html">ya.View</a></li>
            
                <li><a href="../classes/ya.view.$Manager.html">ya.view.$Manager</a></li>
            
                <li><a href="../classes/ya.view.DOM.html">ya.view.DOM</a></li>
            
                <li><a href="../classes/ya.view.Template.html">ya.view.Template</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/ya.html">ya</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\collection.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @namespace ya
 * @class Collection
 * @extends ya.Core
 */
ya.Core.$extend({
    module: &#x27;ya&#x27;,
    alias: &#x27;Collection&#x27;,
    defaults: {
        /**
         * @attribute config.namespace
         * @type String Namespace of collection
         * @required
         */
        namespace: null,
        /**
         * @attribute config.namespace
         * @type ya.data.Proxy Instance of proxy for transfering data
         * @required
         */
        proxy: null
    },
    /**
     * @method init
     * initialize collection
     * @param opts
     */
    init: function (opts) {
        var me = this, config;

        me.__super(opts);

        opts = opts || {};
        config = ya.$merge(me._config, opts.config);

        me.set(&#x27;initOpts&#x27;, opts);
        me.set(&#x27;config&#x27;, config);
        me.set(&#x27;set&#x27;, []);
        me.set(&#x27;cache&#x27;, []);
        me.set(&#x27;removed&#x27;, []);
        me.set(&#x27;filters&#x27;, []);

        me.initConfig();
        me.initData();

        return me;
    },
    /**
     * @method initData
     * initialize data
     */
    initData: function () {
        var me = this,
            data = me.getData() || [];

        me.set(&#x27;raw&#x27;, data);
        me.prepareData(data);

        return me;
    },
    /**
     * @method forEach
     * @param fn
     * @chainable
     */
    forEach: function (fn) {
        var me = this,
            records = me._set,
            t, len;

        t = Object(records);
        len = t.length &gt;&gt;&gt; 0;
        if (typeof fn !== &quot;function&quot;)
            throw new TypeError();

        for (var i = 0; i &lt; len; i++) {
            if (i in t)
                fn.call(me, t[i], i, t);
        }

        return me;
    },
    /**
     * @method push
     * @param records
     * @returns {*}
     * @chainable
     */
    push: function (records) {
        var me = this,
            record,
            ModelDefinition = me.getModel(),
            namespace = me.getNamespace();

        if (!Array.isArray(records)) {
            records = [records];
        }

        while (records.length) {

            record = records.pop();
            record = new ModelDefinition(
                {
                    config: {
                        namespace: namespace,
                        data: record
                    }
                }
            );

            me._cache.push(record);

            me.fireEvent(&#x27;pushed&#x27;, me, record);

        }

        me.filter();

        return me;
    },
    // return number of records in collection
    /**
     * @method count
     * @chainable
     * @returns {Number}
     */
    count: function () {
        return this._set.length;
    },
    /**
     * @method clearFilters
     * @chainable
     * @returns {*}
     */
    clear: function () {
        var me = this;

        me.set(&#x27;set&#x27;, []);
        me.set(&#x27;cache&#x27;, []);
        me.set(&#x27;removed&#x27;, []);

        return me;
    },
    /**
     * @method clearFilters
     * @returns {*}
     * @chainable
     */
    clearFilters: function () {
        var me = this;

        //TODO: clear by multiple filters id
        me.set(&#x27;filters&#x27;, []);
        me.filter();

        return me;
    },
    /**
     *
     * @method clearFilter
     * @param id
     * @returns {*}
     * @chainable
     */
    clearFilter: function (id) {
        var me = this,
            filters = me._filters,
            filLength,
            filter;

        filLength = filters.length;
        while (filLength--) {

            filter = filters[filLength];
            if (typeof filter !== &#x27;function&#x27; &amp;&amp; filter.id === id) {

                filters.splice(filLength, 1);

                break;

            }

        }

        me.filter();

        return me;
    },
    /**
     *
     * @method filter
     * @param fn
     * @returns {*}
     * @chainable
     */
    filter: function (fn) {
        var me = this,
            filters = me._filters,
            filterFn,
            passed = true,
            filtered = [],
            records = me._cache,
            filLength = 0,
            id = null;

        if (arguments.length &gt; 1) {
            id = arguments[0];
            fn = arguments[1];
        }


        if (typeof fn === &#x27;function&#x27;) {

            if (id) {

                filters.push({
                    id: id,
                    fn: fn
                });

            } else {

                filters.push(fn);

            }

            me.fireEvent(&#x27;beforeFilter&#x27;, me, filters);

        }

        for (var i = 0, l = records.length; i &lt; l; i++) {

            passed = true;
            filLength = filters.length;
            while (filLength--) {

                filterFn = typeof filters[filLength] === &#x27;function&#x27; ? filters[filLength] : filters[filLength].fn;
                passed = passed &amp;&amp; filterFn(records[i]);

            }

            if (passed) {

                filtered.push(records[i]);

            }

        }

        me.set(&#x27;set&#x27;, filtered);
        me.fireEvent(&#x27;afterFilter&#x27;, me, filters);

        return me;
    },
    /**
     * get record at
     * @method getAt
     * @param index
     * @returns {ya.Model}
     */
    getAt: function (index) { // Return record by index.
        return this._set[index];
    },
    /**
     * @method getBy
     * @param fn
     * @returns {Array}
     */
    getBy: function (fn) { // Return all matched record.
        var me = this,
            records = me._set,
            filtered = [];

        for (var i = 0, l = records.length; i &lt; l; i++) {

            if (fn(records[i])) {

                filtered.push(records[i]);

            }

        }
        return filtered;
    },
    /**
     * @param fn
     * @returns {}
     */
    findOneBy: function (fn) { // Return index of first matched record.
        var me = this,
            records = me._set,
            len = records.length;

        while (len--) {

            if (fn(records[len])) break;

        }

        return len;
    },
    /**
     * @param fn
     * @returns {Array}
     */
    getOneBy: function (fn) { // Return first matched record.
        var me = this,
            records = me._set,
            record,
            len = records.length;

        while (len--) {

            if (fn(records[len])) {
                record = records[len];
                break;

            }

        }

        return record;
    },
    /**
     * return real number of records
     * @returns {Number}
     */
    getTotal: function () {
        return this._total;
    },
    /**
     * load data
     * proxy need to be set
     * @param params
     */
    load: function (params) {
        var me = this,
            data = me.get(&#x27;data&#x27;),
            idProperty = me.get(&#x27;idProperty&#x27;),
            deferred = ya.$promise.deferred(),
            namespace = me.getNamespace(),
            action = new ya.data.Action(),
            callback,
            key, i = 0;

        for (key in params) i++;

        if (
            i === 0
            )
            throw new Error(&#x27;You need to pass at least one condition to load model collection&#x27;);

        if (!me.getProxy())
            throw new Error(&#x27;To load collection you need to set proxy&#x27;);


        callback = function () {

            if (me.getProxy().getStatus() === &#x27;success&#x27;) {

                me.fireEvent(&#x27;loaded&#x27;, me, action.getResponse(), &#x27;read&#x27;);

            } else {

                me.fireEvent(&#x27;error&#x27;, me, &#x27;read&#x27;);

            }
        };

        action
            .setOptions({
                callback: callback,
                params: params,
                namespace: namespace
            });

        me.getProxy().read(action);

        return deferred.promise;
    },
    save: function () {
        var me = this,
            deferred = ya.$promise.deferred(),
            action,
            toCreate = [],
            toUpdate = [],
            toRemove = me._removed,
            records = me._cache,
            namespace = me.getNamespace(),
            proxy = me.getProxy(),
            toFinish = 0,
            exceptions = [],
            callback,
            record,
            byIdFn;

        for (var i = 0, l = records.length; i &lt; l; i++) {

            record = records[i];
            if (record._isDirty) {

                if (record.hasId()) {

                    toUpdate.push(record._data);

                } else {

                    record._data.__clientId__ = record.get(&#x27;clientId&#x27;);
                    toCreate.push(record._data);

                }
            }

        }

        byIdFn = function (record) {
            return function (_record) {
                return record.__clientId__ ?
                    _record.data(&#x27;__clientId__&#x27;) === record.__clientId__ :
                    _record.data(&#x27;id&#x27;) === record.id;
            };
        };

        callback = function (proxy, action) {

            toFinish--;

            if (action.getStatus() === ya.data.Action.$status.SUCCESS) {

                var response = action.getResponse(),
                    data = response.result,
                    len;

                record = data[0];
                len = data.length;

                // If record has __clientId__ property it&#x27;s create process
                // or if it has id it&#x27;s update.
                if (record &amp;&amp; (record.__clientId__ || record.id)) {

                    while (len--) {

                        record = me.getOneBy(byIdFn(data[len]));
                        record.setDirty(false);

                        delete record._data.__clientId__;

                    }

                } else { // Else it&#x27;s remove process.

                    me.set(&#x27;removed&#x27;, []);

                }

            } else {

                exceptions.push(action.getResponse().error);

            }

            if (toFinish === 0) {

                if (exceptions.length) {

                    me.fireEvent(&#x27;error&#x27;, me, exceptions);

                    deferred.reject({
                        errors: exceptions
                    });

                } else {

                    me.fireEvent(&#x27;success&#x27;, me);

                    deferred.resolve({scope: me});

                }

            }

        };

        if (toCreate.length) {

            toFinish++;

            action = new ya.data.Action();

            action
                .setOptions({
                    namespace: namespace,
                    callback: callback
                })
                .setData(toCreate);

            proxy.create(action);

        }

        if (toUpdate.length) {

            toFinish++;

            action = new ya.data.Action();

            action
                .setOptions({
                    namespace: namespace,
                    callback: callback
                })
                .setData(toUpdate);

            proxy.update(action);
        }

        if (toRemove.length) {

            toFinish++;

            action = new ya.data.Action();

            action
                .setOptions({
                    namespace: namespace,
                    callback: callback
                })
                .setData(toRemove);

            proxy.destroy(action);
        }

        return deferred.promise;
    },
    /**
     * Prepare data
     * @private
     * @param data
     * @param {Number||null} total
     * @returns {Collection}
     */
    prepareData: function (data, total) {
        var me = this,
            ModelInstance = me.getModel(),
            modelConfig = { namespace: me.getNamespace()},
            l = data.length,
            models = [];

        total = total || l;
        for (var i = 0; i &lt; l; i++) {

            modelConfig.data = data[i];
            models.push(new ModelInstance({
                config: modelConfig
            }));

        }

        me.set(&#x27;cache&#x27;, models);
        me.set(&#x27;total&#x27;, total);

        me.filter();

        return me;
    },
    setData: function () {
        var me = this;

        me.setRawData(data);
        me.prepareData(data);

        return me;
    },
    getData: function () {
        return this._set;
    },
    getRawData: function () {
        return this._raw;
    },
    setRawData: function (data) {

        this.set(&#x27;raw&#x27;, data);

        return this;
    },
    isDirty: function () {
        var records = this._cache,
            len = records.length,
            isDirty = false;

        while (len--) {
            if (records[len]._isDirty) {
                isDirty = true;
            }
        }

        if (this._remove) {
            isDirty = true;
        }

        return isDirty;
    }
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
