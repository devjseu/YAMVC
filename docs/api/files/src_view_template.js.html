<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/view/template.js - yam</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="yam"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ya.html">ya</a></li>
            
                <li><a href="../classes/ya.$promise.html">ya.$promise</a></li>
            
                <li><a href="../classes/ya.Ajax.html">ya.Ajax</a></li>
            
                <li><a href="../classes/ya.ajax.JSON.html">ya.ajax.JSON</a></li>
            
                <li><a href="../classes/ya.Collection.html">ya.Collection</a></li>
            
                <li><a href="../classes/ya.collection.$manager.html">ya.collection.$manager</a></li>
            
                <li><a href="../classes/ya.Controller.html">ya.Controller</a></li>
            
                <li><a href="../classes/ya.controller.$manager.html">ya.controller.$manager</a></li>
            
                <li><a href="../classes/ya.Core.html">ya.Core</a></li>
            
                <li><a href="../classes/ya.data.Action.html">ya.data.Action</a></li>
            
                <li><a href="../classes/ya.data.Proxy.html">ya.data.Proxy</a></li>
            
                <li><a href="../classes/ya.data.proxy.LocalStorage.html">ya.data.proxy.LocalStorage</a></li>
            
                <li><a href="../classes/ya.Error.html">ya.Error</a></li>
            
                <li><a href="../classes/ya.event.$dispatcher.html">ya.event.$dispatcher</a></li>
            
                <li><a href="../classes/ya.Job.html">ya.Job</a></li>
            
                <li><a href="../classes/ya.Manager.html">ya.Manager</a></li>
            
                <li><a href="../classes/ya.mixins.Array.html">ya.mixins.Array</a></li>
            
                <li><a href="../classes/ya.mixins.CoreStatic.html">ya.mixins.CoreStatic</a></li>
            
                <li><a href="../classes/ya.mixins.CSSStyle.html">ya.mixins.CSSStyle</a></li>
            
                <li><a href="../classes/ya.mixins.DOM.html">ya.mixins.DOM</a></li>
            
                <li><a href="../classes/ya.mixins.GetSet.html">ya.mixins.GetSet</a></li>
            
                <li><a href="../classes/ya.mixins.Observable.html">ya.mixins.Observable</a></li>
            
                <li><a href="../classes/ya.Model.html">ya.Model</a></li>
            
                <li><a href="../classes/ya.Module.html">ya.Module</a></li>
            
                <li><a href="../classes/ya.Router.html">ya.Router</a></li>
            
                <li><a href="../classes/ya.util.$detection.html">ya.util.$detection</a></li>
            
                <li><a href="../classes/ya.util.Parallel.html">ya.util.Parallel</a></li>
            
                <li><a href="../classes/ya.View.html">ya.View</a></li>
            
                <li><a href="../classes/ya.view.$manager.html">ya.view.$manager</a></li>
            
                <li><a href="../classes/ya.view.TDOM.html">ya.view.TDOM</a></li>
            
                <li><a href="../classes/ya.view.Template.html">ya.view.Template</a></li>
            
                <li><a href="../classes/ya.view.template.$manager.html">ya.view.template.$manager</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/ya.html">ya</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/view/template.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @namespace ya
 * @class ya.view.Template
 * @extends ya.Core
 */
ya.Core.$extend({
    module: &#x27;ya&#x27;,
    alias: &#x27;view.Template&#x27;,
    static: {
        id: 0,
        DOM4: (function () {
            return !document.createAttribute(&#x27;rel&#x27;) instanceof Node;
        }),
        BindingType: {
            IF: 7,
            MODEL: 6,
            CSS: 5,
            VIEW: 4,
            TEXT: 3,
            ATTR: 2,
            COL: 1
        },
        types: {
            td: &#x27;tr&#x27;,
            tr: &#x27;tbody&#x27;,
            thead: &#x27;table&#x27;,
            tfooter: &#x27;table&#x27;,
            tbody: &#x27;table&#x27;
        }
    },
    mixins: [
        ya.mixins.Array
    ],
    defaults: {
        id: null,
        /**
         * @attribute config.tpl
         * @type HTMLElement
         * @required
         */
        tpl: null,
        /**
         * @attribute config.tDOM TDOM object definition
         * @type {Object}
         */
        tDOM: null
    },
    init: function (opts) {
        var me = this;

        me
            .__super(opts)
            .initRegister()
            .initBindings();

    },
    initRequired: function () {
        var me = this;

        if (!me.getTpl()) {

            throw ya.Error.$create(&#x27;ya.view.Template: Missing tpl property in configuration object&#x27;, &#x27;YVT1&#x27;);

        }

        if (!me._html.hasChildNodes()) {

            throw ya.Error.$create(me.__class__ + &#x27;: Its seems that object doesnt contain any template&#x27;, &#x27;YVT2&#x27;);

        }

        return me;
    },
    initDefaults: function () {
        var me = this,
            html = me.getTpl(),
            docFragment = document.createDocumentFragment(),
            types = ya.view.Template.$types,
            tmp;

        me.setId(me.getId() || &#x27;template-&#x27; + ya.view.template.$manager.getUniqueId());
        me.setTDOM(me.getTDOM() || ya.view.TDOM);

        if (Array.isArray(html)) {
            tmp = &#x27;&#x27;;
            // for and concatenating is faster than Array.join
            for (var i = 0, l = html.length; i &lt; l; i++) {

                tmp = tmp + html[i];

            }

            html = tmp;

        }

        if (typeof html === &#x27;string&#x27; || html instanceof String) {
            var firstElMat = html.match(/\&lt;(.*?)[\s|&gt;]/),
                firstEl = firstElMat ? firstElMat[1] : &#x27;&#x27;,
                container = types[firstEl] ? types[firstEl] : &#x27;div&#x27;,
                evaluated = document.createElement(container),
                el;

            evaluated.innerHTML = html;

            while (evaluated.hasChildNodes()) {

                if(evaluated.firstChild.nodeType === 3){
                    el = document.createElement(&#x27;span&#x27;);
                    el.appendChild(evaluated.firstChild);
                    docFragment.appendChild(el);
                }else{
                    docFragment.appendChild(evaluated.firstChild);
                }

            }

        } else if (html instanceof DocumentFragment) {

            docFragment = html;

        } else if (html instanceof HTMLElement) {

            docFragment.appendChild(html.firstChild);

        }

        me.set(&#x27;html&#x27;, docFragment);

        return me;
    },
    initRegister: function () {
        var me = this;

        ya.view.template.$manager.register(
            me.getId(),
            me
        );

        return me;
    },
    /**
     * @method initBindings
     * @private
     * @returns {*}
     */
    initBindings: function () {
        var me = this,
            texts,
            attrs;


        attrs = me.findAttrsBindings();
        texts = me.findTextBindings();

        me.set(&#x27;bindings&#x27;, attrs.concat(texts));

        return me;
    },
    /**
     * Finds all attribute bindings
     * @method findAttrsBindings
     * @private
     */
    findAttrsBindings: function () {
        var me = this,
            attrs = [],
            bindings = [],
            regEx = /^ya-(.*)/i,
            nodeAttrs = [],
            __slice = Array.prototype.slice,
            $DOM4 = ya.view.Template.$DOM4,
            binding,
            walker,
            match,
            attr,
            node;

        walker = document.createTreeWalker( // Create walker object and
            me._html,
            NodeFilter.SHOW_ELEMENT,
            null,
            false
        );

        while (walker.nextNode()) {
            // walk through all nodes

            node = walker.currentNode;
            // HTMLElement node
            // get all attributes
            // and push to array
            nodeAttrs = __slice.call(node.attributes);

            // check if parent contents ya attributes
            // if yes it means that current element is
            // a template and we dont want to check it
            if (me.isTemplate(node)) {
                continue;
            }
            // DOM4 polyfill - attribute no longer inherits from Node
            // so we need to set owner element manually
            if ($DOM4) {
                /*jshint -W083 */
                me.each(nodeAttrs, function (attr) {
                    attr.ownerElement = node;
                });

            }

            attrs = attrs.concat(nodeAttrs);

        }
        // execute attribute processing

        while (attrs.length) {

            attr = attrs.pop();

            match = attr.nodeName.match(regEx);

            switch (match &amp;&amp; match[1]) {
                case &#x27;collection&#x27; :
                    binding = me.prepareColBindings(attr);
                    break;
                case &#x27;view&#x27; :
                    if (attr.ownerElement.hasAttribute(&#x27;ya-if&#x27;)) continue;
                    binding = me.prepareViewBindings(attr);
                    break;
                case &#x27;model&#x27; :
                    binding = me.prepareModelBindings(attr);
                    break;
                case &#x27;css&#x27; :
                    binding = me.prepareCSSBindings(attr);
                    break;
                case &#x27;if&#x27; :
                    binding = me.prepareIfBindings(attr);
                    break;
                default :
                    binding = me.prepareAttrBindings(attr);

            }

            if (binding) {
                bindings.push(binding);
            }

        }

        return bindings;
    },
    /**
     * @method isTemplate
     * @private
     * @param node
     * @returns {boolean}
     */
    isTemplate: function (node) {

        node = node.parentNode;
        while (node.parentNode) {
            if (
                node.attributes.getNamedItem(&#x27;ya-view&#x27;) ||
                node.attributes.getNamedItem(&#x27;ya-collection&#x27;)
            ) {
                return true;

            }

            node = node.parentNode;
        }

        return false;
    },
    /**
     *
     * @method findTextBindings
     * @private
     * @returns {Array}
     */
    findTextBindings: function () {
        var me = this,
            bindings = [],
            binding,
            walker;

        walker = document.createTreeWalker( // Create walker object and
            me._html,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        while (walker.nextNode()) {
            // walk through all nodes

            binding = me.prepareTextBindings(walker.currentNode);
            if (binding) {
                bindings.push(binding);
            }

        }

        // we cant mess with DOM when we walking through it
        // so we need to replace text nodes after we found all
        // matches
        me.each(bindings, function (binding) {

            binding.old.parentNode.replaceChild(binding.doc, binding.old);

            delete binding.doc;
            delete binding.old;

        });

        return bindings;
    },
    /**
     * @method findTextBindings
     * @private
     * @param node
     * @returns {boolean}
     */
    prepareTextBindings: function (node) {
        var results = node.data.match(/\{\{(.*?)\}\}/gi),// we searching for mustached text inside it
            i, len, headers, header, binding = false, result, parts, headerFilters, filters;

        if (results) { // and if we have positive match
            var doc = document.createElement(&#x27;span&#x27;),// we create new span element
            // and id for binding
                rId = ya.view.Template.$id++;

            doc.setAttribute(&#x27;ya-id&#x27;, rId); // and add generated id.

            i = 0;
            len = results.length;
            headers = [];
            filters = [];

            // In the end we replace all match via data.
            while (i &lt; len) {

                result = results[i++];
                header = result.substr(2, (result.length - 4));
                parts = header.split(&#x27;||&#x27;);
                header = parts[0].split(&#x27;.&#x27;);
                if (parts.length &gt; 1) {
                    headerFilters = parts.splice(1);
                } else {
                    headerFilters = [];
                }

                filters.push(headerFilters);
                headers.push(header);

            }

            // We also keep founded bindings.
            binding = {
                original: node.value || node.data,
                old: node,
                doc: doc,
                models: {},
                callbacks: [],
                headers: headers,
                filters: filters,
                type: 3,
                pointer: rId
            };

        }

        return binding;
    },
    prepareModelBindings: function (attr) {
        var node = attr.ownerElement,
            rId = node.getAttribute(&#x27;ya-id&#x27;) || ya.view.Template.$id++,
            options = attr.value.match(/(?:class|namespace)[?!:]([\w\.]+)/gi),
            property = node.getAttribute(&#x27;name&#x27;) || null,
            binding = {
                pointer: rId,
                type: ya.view.Template.$BindingType.MODEL,
                model: {
                    class: &#x27;ya.Model&#x27;,
                    property: property
                }
            },
            option;

        if (!property) {

            throw ya.Error.$create(&#x27;Missing name property in node&#x27;, &#x27;YVT3&#x27;);

        }

        node.setAttribute(&#x27;ya-id&#x27;, rId);

        while (options &amp;&amp; options.length) {
            option = options.pop().split(&#x27;:&#x27;);
            binding.model[option[0]] = option[1];
        }

        return binding;
    },
    prepareIfBindings: function (attr) {
        var condition = attr.value,
            results = condition.match(/\{\{(.*?)\}\}/gi),// we searching for mustached text inside it
            node = attr.ownerElement,
            rId = node.getAttribute(&#x27;ya-id&#x27;) || ya.view.Template.$id++,
            binding = {
                pointer: rId,
                type: ya.view.Template.$BindingType.IF,
                condition: condition,
                models: {},
                callbacks: []
            },
            DOM = ya.mixins.DOM,
            headers = [], header, result, i = 0, len;

        node.setAttribute(&#x27;ya-id&#x27;, rId);

        if (node.hasChildNodes()) {

            binding.tpl = ya.$factory({
                module: &#x27;ya&#x27;,
                alias: &#x27;view.Template&#x27;,
                tpl: DOM.removeChildren(node)
            }).getId();

        }

        if (results) {

            len = results.length;
            while (i &lt; len) {

                result = results[i++];
                header = result.substr(2, (result.length - 4));
                header = header.split(&#x27;.&#x27;);
                headers.push(header);

            }

            binding.headers = headers;
        }

        return binding;
    },
    /**
     * @method prepareColBindings
     * @private
     * @param attr
     * @returns {{pointer: (number), type: (Template.static.BindingType.COL), collection: {view: string, class: string}}}
     */
    prepareColBindings: function (attr) {
        var options = attr.value.match(/(?:class|id|namespace|model|view)[?!:]([\S]+)/gi),
            node = attr.ownerElement,
            rId = node.getAttribute(&#x27;ya-id&#x27;) || ya.view.Template.$id++,
            collection = {
                view: &#x27;ya.View&#x27;,
                class: &#x27;ya.Collection&#x27;
            },
            binding = {
                pointer: rId,
                type: ya.view.Template.$BindingType.COL,
                collection: collection
            },
            DOM = ya.mixins.DOM,
            option;

        node.setAttribute(&#x27;ya-id&#x27;, rId);

        while (options &amp;&amp; options.length) {

            option = options.pop().split(&#x27;:&#x27;);
            collection[option[0]] = option[1];

        }

        if (node.hasChildNodes()) {


            var tpl = ya.$factory({
                module: &#x27;ya&#x27;,
                alias: &#x27;view.Template&#x27;,
                tpl: DOM.removeChildren(node)
            });

            collection.tpl = tpl.getId();

        }

        //console.log(binding);

        return binding;
    },
    /**
     * @method prepareViewBindings
     * @private
     * @param attr
     * @returns {{pointer: (string|number), type: (number|.static.BindingType.VIEW|Template.static.BindingType.VIEW), view: {class: string}}}
     */
    prepareViewBindings: function (attr) {
        var node = attr.ownerElement,
            rId = node.getAttribute(&#x27;ya-id&#x27;) || ya.view.Template.$id++,
            options = attr.value.match(/(?:class|id)[?!:]([\w\.]+)/gi),
            binding = {
                pointer: rId,
                type: ya.view.Template.$BindingType.VIEW,
                view: {
                    class: &#x27;ya.View&#x27;
                }
            },
            option;

        node.setAttribute(&#x27;ya-id&#x27;, rId);

        while (options &amp;&amp; options.length) {
            option = options.pop().split(&#x27;:&#x27;);
            binding.view[option[0]] = option[1];
        }

        return binding;
    },
    /**
     *
     * @method prepareCSSBindings
     * @private
     * @param attr
     * @returns {{original: *, fillAttr: boolean, headers: Array, callbacks: Array, models: {}, name: string, type: *, pointer: string}}
     */
    prepareCSSBindings: function (attr) {
        var node = attr.ownerElement,
            results = attr.value &amp;&amp; attr.value.match(/\{\{(.*?)\}\}/gi),
            len = results &amp;&amp; results.length,
            headers = [], i = 0,
            original, binding, header, rId, style, parts, headerFilters, filters, result;

        rId = node.getAttribute(&#x27;ya-id&#x27;);
        if (!rId) {

            rId = ya.view.Template.$id++;
            node.setAttribute(&#x27;ya-id&#x27;, rId);

        }

        if (results) {

            filters = [];
            while (i &lt; len) {

                result = results[i++];
                header = result.substr(2, (result.length - 4));
                parts = header.split(&#x27;||&#x27;);
                header = parts[0].split(&#x27;.&#x27;);
                if (parts.length &gt; 1) {
                    headerFilters = parts.splice(1);
                } else {
                    headerFilters = [];
                }
                filters.push(headerFilters);
                headers.push(header);

            }

        }

        original = (node.getAttribute(&#x27;style&#x27;) || &quot;&quot;) + attr.value;

        node.setAttribute(&#x27;style&#x27;, original);

        binding = {
            original: original,
            fillAttr: false,
            headers: headers,
            callbacks: [],
            filters: filters,
            models: {},
            name: &#x27;style&#x27;,
            type: ya.view.Template.$BindingType.ATTR,
            pointer: rId
        };

        return binding;
    },
    /**
     *
     * @method prepareAttrBindings
     * @private
     * @param attr
     * @returns {*}
     */
    prepareAttrBindings: function (attr) {
        var node = attr.ownerElement,
            results = attr.value &amp;&amp; attr.value.match(/\{\{(.*?)\}\}/gi),
            len = results &amp;&amp; results.length,
            original = attr.value,
            headers = [], i = 0,
            binding, rId, header, result, parts, headerFilters, filters;

        if (results) {

            rId = node.getAttribute(&#x27;ya-id&#x27;);
            if (!rId) {

                rId = ya.view.Template.$id++;
                node.setAttribute(&#x27;ya-id&#x27;, rId);

            }

            filters = [];
            while (i &lt; len) {

                result = results[i++];
                header = result.substr(2, (result.length - 4));
                parts = header.split(&#x27;||&#x27;);
                header = parts[0].split(&#x27;.&#x27;);
                if (parts.length &gt; 1) {
                    headerFilters = parts.splice(1);
                } else {
                    headerFilters = [];
                }
                filters.push(headerFilters);
                headers.push(header);

            }

            binding = {
                fillAttr: ya.mixins.CSSStyle.isFillAttr(attr.name),
                name: attr.name,
                original: original,
                models: {},
                callbacks: [],
                headers: headers,
                filters: filters,
                type: ya.view.Template.$BindingType.ATTR,
                pointer: rId
            };

        }

        return results ? binding : null;
    },
    /**
     * Returns instance of TDOM object with cloned DOM
     * and biding array
     * @method getTDOMInstance
     * @param view
     * @returns {Function|*}
     */
    getTDOMInstance: function (view) {
        var me = this;

        return me.getTDOM().$create({
            config: {
                view: view,
                bindings: ya.$clone(me.get(&#x27;bindings&#x27;)),
                DOM: me.get(&#x27;html&#x27;).cloneNode(true)
            }
        });
    }
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
